######################################################################
## Virtual host configration for <%= @hostname %>
######################################################################
# 
# Generated by Chef for <%= @node[:fqdn] %>
#
######################################################################

# This vhost is pretty permissive, as it shouldn't be directly web-visible.
# Instead, it should be proxied from the internal system web servers.

# Redirect requests for www.<%= @hostname %> to <%= @hostname %>
<VirtualHost "*:80">

    ServerName www.<%= @hostname %>

    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteRule ^(.*)$ http://<%= @hostname %>$1 [R]
    </IfModule>
    
</VirtualHost>

# Main configuration block for this virtual host
<VirtualHost "*:80">

    # If the request uses the ServerName or ServerAlias as the server name, 
    # then this section will be used, otherwise they will be redirected to
    # the corporate site.

    ServerName <%= @hostname %>

    # The DocumentRoot isn't used for much, anything not inside a webapp.
    # Mainly this is used for the holding page.

    DocumentRoot /usr/share/doc/awstats/html
    
    # Main access block, this allows anonymous access to everything by default
    <Location "/">
        Options FollowSymLinks
        Order allow,deny
        Allow from all
    </Location>

    # This provides worldwide access to everything below the directory
    <Directory /var/lib/awstats>
        Options None
        AllowOverride None
        Order allow,deny
        Allow from all
    </Directory>
    
    # This provides worldwide access to everything below the directory
    <Directory /usr/share/awstats/icon>
        Options None
        AllowOverride None
        Order allow,deny
        Allow from all
    </Directory>
    
    # This provides worldwide access to everything in the directory
    Alias /awstats-icon/ /usr/share/awstats/icon/
    
    # This (hopefully) enables _all_ CGI scripts in the default directory
    ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/

    # Activity for this virtual host goes into separate logs

    # This statement figures out whether X-Forwarded-For is set.
    SetEnvIf X-FORWARDED-FOR "^.*\..*\..*\..*" behind-elb

    CustomLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/access-<%= @hostname %>.log.%Y%m%d 86400" mtm env=!behind-elb
    CustomLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/access-<%= @hostname %>.log.%Y%m%d 86400" mtm-elb env=behind-elb
    ErrorLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/errors-<%= @hostname %>.log.%Y%m%d 86400"
    
    # Remote logging directives
    CustomLog "|/usr/bin/logger -p local6.info -t <%= @hostname %>" mtm env=!behind-elb
    CustomLog "|/usr/bin/logger -p local6.info -t <%= @hostname %>" mtm-elb env=behind-elb 
    ErrorLog "|/usr/bin/logger -p local7.err -t <%= @hostname %>"

</VirtualHost>