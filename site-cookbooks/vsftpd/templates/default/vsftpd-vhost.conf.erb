######################################################################
## Virtual host configration for <%= @hostname %>
######################################################################
# 
# Generated by Chef for <%= @node[:fqdn] %>
#
######################################################################

# Main configuration block for this virtual host
<VirtualHost "*:80">

    # If the request uses the ServerName or ServerAlias as the server name, 
    # then this section will be used, otherwise they will be redirected to
    # the corporate site.

    ServerName <%= @hostname %>

    <% @aliases.each do |alias| -%>
    ServerAlias <%= alias %>
    <% end -%>

    # The DocumentRoot isn't used for much, anything not inside a webapp.
    # Mainly this is used for the holding page.

    DocumentRoot /var/www/vhosts/<%= @hostname %>
    
    <% @users.each do |user| -%>
    Alias /<%= user %> <%= @ftp_base %>/<%= user %>
    <% end -%>

    Alias /icons "/usr/share/apache2/icons"

    <Directory "/usr/share/apache2/icons">
        Options Indexes MultiViews
        AllowOverride None
        Order allow,deny
        Allow from all
    </Directory>

    <% @users.each do |user| -%>
    <Directory <%= @ftp_base %>/<%= user %>>
	Options FollowSymLinks Indexes
        AuthType Basic
        AuthName "<%= user %> extranet area"
        AuthBasicProvider external
        AuthExternal pwauth
        Require user <%= user %>
        Allow from all
    </Directory>
    
    AddExternalAuth pwauth /usr/sbin/pwauth
    SetExternalAuthMethod pwauth pipe

    <% end -%>
    <IfModule mod_rewrite.c>
        RewriteEngine On
        <% @users.each do |user| -%>
        RewriteCond %{REQUEST_URI} !/<%= user %>
        <% end -%>
        RewriteCond %{REQUEST_URI} !/icons
        RewriteRule ^/(.*) http://www.mapofmedicine.com [R,L]
    </IfModule>
    
    # Use the specified error page (under DocumentRoot) for the specified error codes.
    # They are prettier than the standard Apache pages.

    ErrorDocument 403 /403/index.html 
    ErrorDocument 404 /404/index.html 

    # Activity for this virtual host goes into separate logs
    
    # This statement figures out whether X-Forwarded-For is set.
    SetEnvIf X-FORWARDED-FOR "^.*\..*\..*\..*" behind-elb

    CustomLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/access-<%= @hostname %>.log.%Y%m%d 86400" mtm env=!behind-elb
    CustomLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/access-<%= @hostname %>.log.%Y%m%d 86400" mtm-elb env=behind-elb
    
    ErrorLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/errors-<%= @hostname %>.log.%Y%m%d 86400"

</VirtualHost>
