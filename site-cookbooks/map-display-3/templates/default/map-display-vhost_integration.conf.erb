######################################################################
## Virtual host configration for <%= @hostname %>
######################################################################
# 
# Generated by Chef for <%= @node[:fqdn] %>
#
######################################################################

# Redirect requests for www.<%= @hostname %> to <%= @hostname %>
<VirtualHost "*:80">
    ServerName www.<%= @hostname %>

    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteRule ^(.*)$ http://<%= @hostname %>$1 [R]
    </IfModule>
</VirtualHost>

# Main configuration block for this virtual host
<VirtualHost "*:80">

    # If the request uses the ServerName or ServerAlias as the server name, 
    # then this section will be used, otherwise they will be redirected to
    # the corporate site.

    ServerName <%= @hostname %>
    <% @srv_aliases.each do |srv_alias| -%>
    ServerAlias <%= srv_alias %>
    <% end -%>

    # The DocumentRoot isn't used for much, anything not inside a webapp.
    # Mainly this is used for the holding page.

    DocumentRoot /var/www/vhosts/<%= @hostname %>
    
    # These are the main ajp proxy directives, they tell Apache to pass requests
    # to Tomcat.
    
    # In this iteration, one web server is hardlinked to a backend appserver. In
    # the future, we'll do somethis more clever with mod_proxy_balancer

    ProxyPass /mom/  ajp://<%= @appserver %>:<%= @mom_port %>/mom/
    ProxyPass /adminapp  ajp://<%= @appserver %>:<%= @aa_port %>/adminapp
    ProxyPass /tomcat-manager  ajp://<%= @appserver %>:<%= @mom_port %>/tomcat-manager
    ProxyPass /mapalongside/  ajp://<%= @appserver %>:<%= @mom_port %>/mapalongside/
    ProxyPass /referrals  ajp://<%= @appserver %>:<%= @aa_port %>/referrals

    # Main access block, this allows anonymous access to everything by default
    <Location "/">
        Options FollowSymLinks
        Order allow,deny
        Allow from all
    </Location>

    # Restricted access for the Tomcat manager webapp, locked by IP address.
    <Location "/tomcat-manager">
        Order deny,allow
        Deny from all
        Allow from 127.0.0.1
        <% @restricted_ips.each do |ip| -%>
        Allow from <%= ip %>
        <% end -%>
    </Location>
    
    # Use the specified error page (under DocumentRoot) for the specified error codes.
    # They are prettier than the standard Apache pages.

    ErrorDocument 403 /403/index.html 
    ErrorDocument 404 /404/index.html 

    <IfModule mod_rewrite.c>
        RewriteEngine On
        
        <% if @holding_page == 'true' -%>
        # The holding page is ENABLED
        RewriteRule ^/mom /holding.html [R]
        <% else -%>
        # The holding page is DISABLED
        RewriteRule ^/holding.html / [R]
        <% end -%>
        
        ## These lines divert all disabled London and Wales views to the corporate site.
        
        # Wales views
        RewriteRule ^/mom/4/.+ http://www.mapofmedicine.com/support/wales [R,L]
        RewriteRule ^/mom/5/.+ http://www.mapofmedicine.com/support/wales [R,L]
        RewriteRule ^/mom/6/.+ http://www.mapofmedicine.com/support/wales [R,L]
        RewriteRule ^/mom/7/.+ http://www.mapofmedicine.com/support/wales [R,L]
        RewriteRule ^/mom/44/.+ http://www.mapofmedicine.com/support/wales [R,L]
        RewriteRule ^/mom/45/.+ http://www.mapofmedicine.com/support/wales [R,L]
        RewriteRule ^/mom/47/.+ http://www.mapofmedicine.com/support/wales [R,L]
        RewriteRule ^/mom/101/.+ http://www.mapofmedicine.com/support/wales [R,L]
        RewriteRule ^/mom/105/.+ http://www.mapofmedicine.com/support/wales [R,L]
        RewriteRule ^/mom/139/.+ http://www.mapofmedicine.com/support/wales [R,L]
        
        # London views
        RewriteRule ^/mom/61/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/119/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/171/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/172/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/173/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/174/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/182/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/183/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/198/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/199/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/200/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/201/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/188/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/180/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/181/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/195/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/196/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/197/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/121/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/186/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/187/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/175/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/176/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/2/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/111/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/189/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/132/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/184/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/103/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/179/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/190/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/191/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/192/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/193/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/194/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/140/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/143/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/185/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/177/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/178/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/112/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/145/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/120/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/122/.+ http://www.mapofmedicine.com/support/london [R,L]
        RewriteRule ^/mom/123/.+ http://www.mapofmedicine.com/support/london [R,L]

        # Fix for the Desktop icon
        RewriteRule ^/mom/london/index.html http://www.mapofmedicine.com/support/london [R,L]
        
        # Redirect any access to the base URL to the mom index page, plus a few other
        # URL cleanups

        RewriteRule ^/$ /mom/1/index.html [R,L]
        RewriteRule ^/mom/(\d+)/?$ /mom/$1/index.html [R,L]
        RewriteRule ^/admin$ /adminapp [R,L]
        
        # Added to 'fix' issue in OPS-24530
        
        RewriteCond %{REQUEST_URI} ^/mom/(\d+)/login_page\.html$
        RewriteCond %{QUERY_STRING} !.+
        RewriteRule ^/mom/(\d+)/login_page\.html$ /mom/$1/index.html [R,L]

    </IfModule>

    # Activity for this virtual host goes into separate logs
    
    # This statement figures out whether X-Forwarded-For is set.
    SetEnvIf X-FORWARDED-FOR "^.*\..*\..*\..*" behind-elb

    CustomLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/access-<%= @hostname %>.log.%Y%m%d 86400" mtm env=!behind-elb
    CustomLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/access-<%= @hostname %>.log.%Y%m%d 86400" mtm-elb env=behind-elb
    
    ErrorLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/errors-<%= @hostname %>.log.%Y%m%d 86400"

    <Location "/mom">       
            Header append P3P 'CP="IDC DSP COR CUR ADM DEVo TAIo PSA PSDo IVA IVDo CONo HISo TELo OUR OTRo STP UNI"' 
    </Location>

</VirtualHost>

# turn on far future expire header for js and css files marked  with "-hardcache-\[ timestamp \]" in the file name 
  <LocationMatch "-hardcache-\d+\.(js\|css)$">
   ExpiresActive On
     ExpiresDefault "access plus 1 year"
   </LocationMatch>

# remove unused ETag headers  
 Header unset ETag


<% if @lb_alive_port != 0 -%>
# This stansa is used by the ELB healthcheck

<VirtualHost "*:<%= @lb_alive_port %>">

    DocumentRoot /var/www/vhosts/<%= @hostname %>

    ProxyPass /mom/keepalive.html  ajp://<%= @appserver %>:9001/mom/keepalive.html
    
    <Location "/mom">
        Options FollowSymLinks
        Order allow,deny
        Allow from all
    </Location>

    <Directory "/var/www/vhosts/<%= @hostname %>">
        Options FollowSymLinks
        AllowOverride None
        Order allow,deny
        Allow from all
    </Directory>
   
    CustomLog /dev/null common
    ErrorLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/errors-<%= @hostname %>-keepalive.log.%Y%m%d 86400"

</VirtualHost>
<% end -%>
