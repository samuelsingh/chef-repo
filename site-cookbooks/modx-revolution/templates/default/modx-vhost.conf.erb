######################################################################
## Virtual host configration for <%= @hostname %>
######################################################################
# 
# Generated by Chef for <%= @node[:fqdn] %>
#
######################################################################

# Redirect requests to www.<%= @hostname %>
<VirtualHost "*:80">

    ServerName <%= @hostname %>
    <% @srv_aliases.each do |srv_alias| -%>
    ServerAlias <%= srv_alias %>
    <% end -%>
    
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteRule ^(.*)$ http://www.<%= @hostname %>$1 [R]
    </IfModule>
</VirtualHost>

# Main configuration block for this virtual host
<VirtualHost "*:80">

    ServerName www.<%= @hostname %>

    # The DocumentRoot isn't used for much, anything not inside a webapp.
    # Mainly this is used for the holding page.

    DocumentRoot <%= @modx_path %>
    
    # Workaround for secure access via ELB
    <% @restricted_ips.each do |ip| -%>
    SetEnvIF X-FORWARDED-FOR "<%= ip %>" ELBAUTH
    <% end -%>

    # Main access block, this allows anonymous access to everything by default
    <Location "/">
        DirectoryIndex index.php index.html
        Options FollowSymLinks
        Order allow,deny
        Allow from all
    </Location>

    # Restricted access for ModX manager, locked by IP address.
    <Location "/manager">
        Order deny,allow
        Deny from all
        Allow from 127.0.0.1
        <% @restricted_ips.each do |ip| -%>
        Allow from <%= ip %>
        <% end -%>
        Allow from env=ELBAUTH
    </Location>
    
    <Directory "<%= @modx_path %>">
        Options Indexes +FollowSymLinks
        AllowOverride None
        Order allow,deny
        Allow from all
        
        RewriteEngine On
        RewriteBase <%= @modx_path %>/
        
        # Fix Apache internal dummy connections from breaking [(site_url)] cache
        RewriteCond %{HTTP_USER_AGENT} ^.*internal\ dummy\ connection.*$ [NC]
        RewriteRule .* - [F,L]
        
        # Exclude /assets and /manager directories from rewrite rules
        RewriteRule ^(manager|assets|global) - [L]
        
        # Rewrite legacy document links
        RewriteRule ^(Documents|documents) /global/documents [L]
        
        # Supply a friendly url for newsrss
        RewriteRule ^newsrss$ /newsrss.xml [L]
        
        # For Friendly URLs
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ /index.php?q=$1 [L,QSA,NC]
    </Directory>


    # Activity for this virtual host goes into separate logs
    
    # This statement figures out whether X-Forwarded-For is set.
    SetEnvIf X-FORWARDED-FOR "^.*\..*\..*\..*" behind-elb

    CustomLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/access-<%= @hostname %>.log.%Y%m%d 86400" mtm env=!behind-elb
    CustomLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/access-<%= @hostname %>.log.%Y%m%d 86400" mtm-elb env=behind-elb
    
    ErrorLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/errors-<%= @hostname %>.log.%Y%m%d 86400"
    
    # Remote logging directives
    CustomLog "|/usr/bin/logger -p local6.info -t <%= @hostname %>" mtm env=!behind-elb
    CustomLog "|/usr/bin/logger -p local6.info -t <%= @hostname %>" mtm-elb env=behind-elb 

    ErrorLog "|/usr/bin/logger -p local7.err -t <%= @hostname %>"

</VirtualHost>