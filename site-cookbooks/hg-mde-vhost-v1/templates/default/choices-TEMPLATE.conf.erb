######################################################################
## Virtual host configration for <%= @hostname %>
######################################################################
# 
# Generated by Chef for <%= @node[:fqdn] %>
#
######################################################################

# Redirect requests for www.<%= @hostname %> to <%= @hostname %>
<VirtualHost "*:80">
    ServerName www.<%= @hostname %>

   <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteRule ^(.*)$ http://<%= @hostname %>$1 [R]
   </IfModule>
</VirtualHost>

# Main configuration block for this virtual host
<VirtualHost "*:80">

    # If the request uses the ServerName or ServerAlias as the server name, 
    # then this section will be used, otherwise they will be redirected to
    # the corporate site.

    ServerName <%= @hostname %>
    <% @srv_aliases.each do |srv_alias| -%>
    ServerAlias <%= srv_alias %>
    <% end -%>

    # The DocumentRoot isn't used for much, anything not inside a webapp.
    # Mainly this is used for the holding page.
    DocumentRoot /var/www/vhosts/<%= @hostname %>

    # These are the main ajp proxy directives, they tell Apache to pass requests
    # to Tomcat.
    
    # In this iteration, one web server is hardlinked to a backend appserver. In
    # the future, we'll do somethis more clever with mod_proxy_balancer

    <% @webapps.each do |webapp,params| -%>
    ProxyPass /<%= webapp %>     ajp://<%= params.fetch("appserver") %>:<%= params.fetch("port") %>/<%= webapp %>
    <% end -%>

    # Main access block, this allows anonymous access to everything by default
    <Location "/">
        Options FollowSymLinks
        Order allow,deny
        Allow from all
    </Location>

    <Location "/robots.txt">
        SetHandler None
    </Location>
    
    
    # Workaround for secure access via ELB
    <% @restricted_ips.each do |ip| -%>
    SetEnvIF X-FORWARDED-FOR "<%= ip %>" ELBAUTH
    <% end -%>

    # Restricted access for the Tomcat manager webapp, locked by IP address.
    <Location "/tomcat-manager">
        Order deny,allow
        Deny from all
        Allow from 127.0.0.1
        <% @restricted_ips.each do |ip| -%>
        Allow from <%= ip %>
        <% end -%>
        Allow from env=ELBAUTH
    </Location>
    
    # Restricted access to feedback, locked by IP address.
    <Location "/choices/feedback/feedback.txt">
        Header set Cache-Control "max-age=0, private, no-store, no-cache, must-revalidate"
        Order deny,allow
        Deny from all
        Allow from 127.0.0.1
        <% @restricted_ips.each do |ip| -%>
        Allow from <%= ip %>
        <% end -%>
        Allow from env=ELBAUTH
    </Location>
    
    # Restricted access to feedback, locked by IP address.
    <Location "/choices/selenium">
        Header set Cache-Control "max-age=0, private, no-store, no-cache, must-revalidate"
        Order deny,allow
        Deny from all
        Allow from 127.0.0.1
        <% @restricted_ips.each do |ip| -%>
        Allow from <%= ip %>
        <% end -%>
        Allow from env=ELBAUTH
    </Location>
    
    <% unless @awstats == true -%>
    # AWStats configuration
    
    ProxyPass /stats     http://awstats.<%= @node[:domain] %>
    
    <Location "/stats">
        Order deny,allow
        Deny from all
        Allow from 127.0.0.1
        <% @restricted_ips.each do |ip| -%>
        Allow from <%= ip %>
        <% end -%>
        Allow from env=ELBAUTH
    </Location>
    <% end -%>

    <Directory "/var/www/vhosts/<%= @hostname %>">
	Options FollowSymLinks
        AllowOverride None
        Order allow,deny
        Allow from all
    </Directory>
    

    # Use the specified error page (under DocumentRoot) for the specified error codes.
    # They are prettier than the standard Apache pages.

    ErrorDocument 403 /403/index.html 
    ErrorDocument 404 /404/index.html 

    <IfModule mod_rewrite.c>
        RewriteEngine On
        
        <% if @holding_page == 'true' -%>
        # The holding page is ENABLED
        <% @webapps.each do |webapp,params| -%>
        RewriteRule ^/<% webapp -%> /holding.html [R]
        <% end -%>
        
        <% else -%>
        # The holding page is DISABLED
        RewriteRule ^/holding.html / [R]
        <% end -%>
        
        # Redirect access to the base URL to the <%= @primary_webapp %> index page
        RewriteRule ^/$ /<%= @primary_webapp %> [R,L]
        
        # Replaces the nasty double proxy lines used previously
        RewriteRule ^/professional(.*) /choices$1 [R,L]
        # Not sure what this one is needed for...
        RewriteRule ^/map(.*)/?$ / [R,L]
        
        <% unless @awstats == true -%>
        # Redirect for AWStats
        RewriteRule ^/stats$ /stats/cgi-bin/awstats.pl?config=<%= @hostname %> [R,L]
        RewriteRule ^/awstats-icon/(.+) /stats/awstats-icon/$1 [R,L]
        <% end -%>

    </IfModule>

    # Activity for this virtual host goes into separate logs

    # This statement figures out whether X-Forwarded-For is set.
    SetEnvIf X-FORWARDED-FOR "^.*\..*\..*\..*" behind-elb

    CustomLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/access-<%= @hostname %>.log.%Y%m%d 86400" mtm env=!behind-elb
    CustomLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/access-<%= @hostname %>.log.%Y%m%d 86400" mtm-elb env=behind-elb
    ErrorLog "|/usr/sbin/rotatelogs <%= @node[:apache][:log_dir] %>/errors-<%= @hostname %>.log.%Y%m%d 86400"
    
    # Remote logging directives
    
    CustomLog "|/usr/bin/logger -p local6.info -t <%= @hostname %>" mtm env=!behind-elb
    CustomLog "|/usr/bin/logger -p local6.info -t <%= @hostname %>" mtm-elb env=behind-elb 
    ErrorLog "|/usr/bin/logger -p local7.err -t <%= @hostname %>"

</VirtualHost>
