# Generated by Chef for <%= @node[:fqdn] %>
#

# Configuration for <%= @mount_point %>

<% @glustersrvs.each do |glustersrv| %>
<% shortid = glustersrv[/\A[^\.]+\./].gsub(".","") -%>
volume <%= shortid %>_<%= @mount_point %>
    type protocol/client
    option transport-type tcp
    option transport.socket.nodelay on
    option remote-host <%= glustersrv %>
    option remote-subvolume export_<%= @mount_point %>
end-volume

<% end -%>

<% @subvols = Array.new -%>
<% @glustersrvs.each do |glustersrv| -%>
<% shortid = glustersrv[/\A[^\.]+\./].gsub(".","") -%>
<% @subvols << "#{shortid}_#{@mount_point}" -%>
<% end -%>

volume mirror_<%= @mount_point %>
    type cluster/replicate
    subvolumes <%= @subvols.join(" ") %>
end-volume

volume iothreads_<%= @mount_point %>
  type performance/io-threads
  option thread-count 16  # default is 1
  subvolumes mirror_<%= @mount_point %>
end-volume

volume iocache_<%= @mount_point %>
  type performance/io-cache
  option cache-size 256MB               # default is 32MB
  option cache-timeout 2                # default is 1 second
  subvolumes iothreads_<%= @mount_point %>
end-volume

volume readahead_<%= @mount_point %>
  type performance/read-ahead
  option page-size 128KB
  option page-count 10           # 2 is default option
  option force-atime-update off  # default is off
  option cache-timeout 2         # default 1 second
  subvolumes iocache_<%= @mount_point %>
end-volume

volume writebehind_<%= @mount_point %>
  type performance/write-behind
  option cache-size 32MB
  option flush-behind on         # default is 'off'
  option cache-timeout 10        # default 1 second
  subvolumes readahead_<%= @mount_point %>
end-volume

volume quickread_<%= @mount_point %>
  type performance/quick-read
  option cache-timeout 2         # default 1 second
  option max-file-size 128KB     # default 64Kb
  subvolumes writebehind_<%= @mount_point %>
end-volume
